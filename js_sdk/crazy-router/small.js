import regeneratorRuntime from "regenerator-runtime";import r from"url";function e(r){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r})(r)}function t(r,e,t,n,a,u,o){try{var c=r[u](o),i=c.value}catch(r){return void t(r)}c.done?e(i):Promise.resolve(i).then(n,a)}function n(r){return function(){var e=this,n=arguments;return new Promise((function(a,u){var o=r.apply(e,n);function c(r){t(o,a,u,c,i,"next",r)}function i(r){t(o,a,u,c,i,"throw",r)}c(void 0)}))}}function a(r,e){for(var t=0;e.length>t;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function u(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function o(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),t.push.apply(t,n)}return t}function c(r){for(var e=1;arguments.length>e;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?o(Object(t),!0).forEach((function(e){u(r,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))}))}return r}function i(r,e){(null==e||e>r.length)&&(e=r.length);for(var t=0,n=Array(e);e>t;t++)n[t]=r[t];return n}function s(r){if("undefined"==typeof Symbol||null==r[Symbol.iterator]){if(Array.isArray(r)||(r=function(r,e){if(r){if("string"==typeof r)return i(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(t):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?i(r,e):void 0}}(r))){var e=0,t=function(){};return{s:t,n:function(){return r.length>e?{done:!1,value:r[e++]}:{done:!0}},e:function(r){throw r},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,a,u=!0,o=!1;return{s:function(){n=r[Symbol.iterator]()},n:function(){var r=n.next();return u=r.done,r},e:function(r){o=!0,a=r},f:function(){try{u||null==n.return||n.return()}finally{if(o)throw a}}}}var f=[],l=[],p=[],m={allowAction:!0,routerParams:null,passedParams:null,current:{},afterNotNext:null,actionInfo:{navigateBack:null,switchTab:null},actionType:null},v=process.env.VUE_APP_PLATFORM,h=!1;function y(r,e){var t=r.indexOf(e);r.splice(t,1)}function g(r,e,t){return b.apply(this,arguments)}function b(){return(b=n(regeneratorRuntime.mark((function r(e,t,n){var a,u,o,c,i;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:u=function(){m.afterNotNext=null,a=!1},a=!0,o=s(e),r.prev=3,o.s();case 5:if((c=o.n()).done){r.next=14;break}return i=c.value,r.next=9,i(t,n,u);case 9:if(!a){r.next=11;break}return r.abrupt("return",!1);case 11:a=!0;case 12:r.next=5;break;case 14:r.next=19;break;case 16:r.prev=16,r.t0=r.catch(3),o.e(r.t0);case 19:return r.prev=19,o.f(),r.finish(19);case 22:return r.abrupt("return",!0);case 23:case"end":return r.stop()}}),r,null,[[3,16,19,22]])})))).apply(this,arguments)}function P(r,e,t){r.forEach((function(r){r(e,t)}))}function d(r){var e=m[r];return m[r]=null,e}function w(r,t){return"object"===e(r[t])&&(m[t]=c({},r[t])),r}function $(){var r=m.afterNotNext;m.afterNotNext=null,"function"==typeof r&&r()}function x(r,e,t,n){return k.apply(this,arguments)}function k(){return(k=n(regeneratorRuntime.mark((function r(e,t,n,a){var u,o;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,e;case 3:if(1!==(u=r.sent).length){r.next=9;break}m.allowAction=!0,P(p,t,n),r.next=13;break;case 9:if("reLaunch"!==a||1!==getCurrentPages().length||A()!==t.url||"h5"!==v){r.next=12;break}return C(),r.abrupt("return",u);case 12:("navigateBack"===a&&1===getCurrentPages().length||"app-plus"===v)&&(C(),"$routeParams"in(o=S())||(o.$routeParams=d("routeParams")),o.$passedParams=d("passedParams"),o.$vm&&(o.$vm.$passedParams=o.$passedParams,"$routeParams"in o.$vm||(o.$vm.$routeParams=d("routeParams"))),P(l,t,n),m.current=E());case 13:return r.abrupt("return",u);case 16:return r.prev=16,r.t0=r.catch(0),r.abrupt("return",Error(r.t0));case 19:case"end":return r.stop()}}),r,null,[[0,16]])})))).apply(this,arguments)}function O(r){var e=c({},r);return Object.keys(e).forEach((function(r){e[r]=decodeURIComponent(e[r])})),e}function j(r){if(r)return"h5"===v?r.$mp.query:r.options}function A(){var r=getCurrentPages();return r[r.length-1].route}function S(){var r=getCurrentPages();return r[r.length-1]}function E(){var r=S(),e=j(r);return"h5"!==v&&(e=O(e)),{url:A(),routeParams:r.$routeParams,passedParams:r.$passedParams,query:e}}function C(r){h&&(m.allowAction=!0,r&&r()),h=!1}function T(e){var t=uni[e];uni[e]=function(a){return function(e){var t=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},u=arguments.length>2?arguments[2]:void 0;try{A()}catch(r){return e.call(uni,a)}var o=E(),c=a.fail,i=a.success,s=a.complete;if(!m.allowAction){var y="动作被拦截，因为已经有一个正在执行的路由动作";return c||i||s?a.fail&&a.fail({errMsg:y}):[{errMsg:y}]}m.allowAction=!1,h=!1;var b,k=A(),T={};if("navigateBack"===u){var N=a.delta,R=void 0===N?1:N,I=getCurrentPages().length-1-R;0>I&&(I=0),m.actionInfo.navigateBack=I,b=getCurrentPages()[I].route,T=j(getCurrentPages()[I]),"h5"!==v&&(T=O(T))}else{var B=(b=r.resolve(k,a.url||"").replace(/^\/([^\/])/,"$1")).match(/([^?]+)\?([\s\S]*)/);b=B&&B[1]||b,B&&B[2]&&B[2].split("&").forEach((function(r){if(r){var e=r.match(/^([^=]+)=([\s\S]*)$/);e&&e[2]?T[e[1]]=e[2]:T[r]=""}})),T=O(T)}"switchTab"===u&&(m.actionInfo.switchTab=b),m.actionType=u;var M={url:b,routeParams:a.routeParams,passedParams:a.passedParams,query:T,jumpType:u};return c||i||s?(a.fail=function(){if(m.allowAction=!0,P(p,M,"app-plus"===v?o:m.current),c){for(var r=arguments.length,e=Array(r),n=0;r>n;n++)e[n]=arguments[n];return c.apply(t,e)}},"reLaunch"===u&&1===getCurrentPages().length&&A()===M.url&&"h5"===v&&(a.success=function(){if(C(),i){for(var r=arguments.length,e=Array(r),n=0;r>n;n++)e[n]=arguments[n];return i.apply(t,e)}}),("navigateBack"===u&&1===getCurrentPages().length||"app-plus"===v)&&(a.success=function(){C();var r=S();if("$routeParams"in r||(r.$routeParams=d("routeParams")),r.$passedParams=d("passedParams"),r.$vm&&(r.$vm.$passedParams=r.$passedParams,"$routeParams"in r.$vm||(r.$vm.$routeParams=d("routeParams"))),P(l,M,"app-plus"===v?o:m.current),m.current=E(),i){for(var e=arguments.length,n=Array(e),a=0;e>a;a++)n[a]=arguments[a];return i.apply(t,n)}}),void n(regeneratorRuntime.mark((function r(){return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,g(f,M,"app-plus"===v?o:m.current);case 2:if(r.sent){r.next=6;break}return a.fail({errMsg:"beforeEach中没有使用next"}),$(),r.abrupt("return");case 6:h=!0,e.call(uni,w(w(a,"routeParams"),"passedParams"));case 8:case"end":return r.stop()}}),r)})))()):n(regeneratorRuntime.mark((function r(){var t;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,g(f,M,"app-plus"===v?o:m.current);case 2:if(r.sent){r.next=6;break}return m.allowAction=!0,$(),r.abrupt("return",[{errMsg:"beforeEach中没有使用next"}]);case 6:return h=!0,t=e.call(uni,w(w(a,"routeParams"),"passedParams")),r.abrupt("return",x(t,M,"app-plus"===v?o:m.current,u));case 9:case"end":return r.stop()}}),r)})))()}(t,a,e)}}function N(r,e){r.mixin({onLoad:function(){"app-plus"!==v&&(S().$routeParams=this.$routeParams=d("routeParams"))},onShow:function(){var r=this,e=function(){C((function(){S().$passedParams=r.$passedParams=d("passedParams")})),P(l,E(),m.current),m.current=E()};if("app-plus"!==v){try{A()}catch(r){return}this.globalData||e()}else 1>getCurrentPages().length&&function r(e){try{S(),e&&e()}catch(t){setTimeout((function(){r(e)}),13)}}(e)}}),T("navigateTo"),T("redirectTo"),T("reLaunch"),T("switchTab"),T("navigateBack")}var R=new(function(){function r(){!function(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}(this,r)}var e,t,n;return e=r,(t=[{key:"beforeEach",value:function(r){return f.push(r),function(){y(f,r)}}},{key:"afterEach",value:function(r){return l.push(r),function(){y(l,r)}}},{key:"onError",value:function(r){return p.push(r),function(){y(p,r)}}},{key:"afterNotNext",value:function(r){return m.afterNotNext=r,this}},{key:"install",value:function(r,e){return N(r),this}}])&&a(e.prototype,t),n&&a(e,n),r}());export default R;
